import select
import psycopg2
import psycopg2.extensions
import logging
import sys
import signal
import os

import pyinotify
import xmltodict
import datetime
import time

from flask import Flask, request
from flask_restful import Resource, Api
from psycopg2.extensions import AsIs
from multiprocessing import Process, Queue

from topology import nodes, edges
from classes import alertProcessing as AP

logger = logging.getLogger("idrs")

listenTo = []
name = 'RestAPIPsql'

def createInsertStatement(self, obj):

    objDict = obj.__dict__

    cols = objDict.keys()
    vals = [objDict[x] for x in cols]

    insert_statement = 'insert into ' + obj.__class__.__name__.lower() + ' (%s) values %s'
    statement = self.cur.mogrify(insert_statement, (AsIs(','.join(cols)), tuple(vals)))
    return statement

class IDMEF(Resource):
    def __init__ (self, cur, conn):
        self.cur = cur
        self.conn = conn

    def put(self):
        data = request.form['data']
        dataDict = xmltodict.parse(data)
        if type(dataDict['IDMEF-Message']['Alert']) is list:
            elem = dataDict['IDMEF-Message']['Alert']
        else:
            elem = []
            elem.append(dataDict['IDMEF-Message']['Alert'])
        for alert in elem:

            alertToInsert = AP.Alert(alert['@messageid'])
            alertToInsert.target = alert['Target']['Node']['Address']['address']
            alertToInsert.source = alert['Source']['Node']['Address']['address']
            alertToInsert.classification = alert['Classification']['@text']
            alertToInsert.dt = alert['CreateTime']
            formattedTime = time.strptime(alertToInsert.dt, "%Y-%m-%dT%H:%M:%S.%fZ")
            dt = datetime.datetime.fromtimestamp(time.mktime(formattedTime))
            alertToInsert.creationDate = datetime.datetime.date(dt)
            alertToInsert.creationTime = datetime.datetime.time(dt)
            statement = 'select id from ip where name = %s'
            self.cur.execute(statement, (target, ))
            targetID = self.cur.fetchone()[0]
            self.cur.execute(statement, (source, ))
            sourceID = self.cur.fetchone()[0]
            
            statement = 'select id from attack where name like %s'
            self.cur.execute(statement, (classification, ))
            classificationID = self.cur.fetchone()[0]

            statement = "select id from alert where detectiontime_date = %s AND detectiontime_time = %s AND name = %s;"
            statement = self.cur.mogrify(statement, (creationDate, creationTime, msgid, ))
            self.cur.execute(statement)

            result = self.cur.fetchone()
            if result == None:

                statement = 'insert into alert (detectiontime_date, detectiontime_time, name) VALUES(%s, %s,%s) RETURNING id'
                statement = self.cur.mogrify(statement, (creationDate, creationTime, msgid, ))
                self.cur.execute(statement)
                alertID = self.cur.fetchone()[0]

            else:   
                alertID = result[0]

            statement = 'select a.id from alertContext a, alertContexthasSource s, alertContexthasTarget t, alertContextIsOfType ty where s.tonode = %s and t.tonode = %s and ty.tonode = %s and ty.fromnode = a.id and s.fromnode = a.id and t.fromnode = a.id'
            statement = self.cur.mogrify(statement, (sourceID, targetID, classificationID, ))
            self.cur.execute(statement)
            alertContextID = self.cur.fetchone()

            if alertContextID == None:
                statement = 'insert into alertContext (name, _solved) VALUES(%s,%s) RETURNING id'
                statement = self.cur.mogrify(statement, (str(source + "_" + target + "_" + classification), False, ))
                self.cur.execute(statement)
                alertContextID = self.cur.fetchone()[0]
                statement = 'insert into alertContextIsOfType (fromnode,tonode,name) VALUES(%s,%s,%s) RETURNING id'
                statement = self.cur.mogrify(statement, (alertContextID, classificationID, "alertcontextisoftype", ))
                self.cur.execute(statement)
                statement = 'insert into alertContexthasSource (fromnode,tonode,name) VALUES(%s, %s, %s)'
                statement = self.cur.mogrify(statement, (alertContextID, sourceID, "alertcontexthassource", ))
                self.cur.execute(statement)
                statement = 'insert into alertContexthasTarget (fromnode,tonode,name) VALUES(%s, %s,%s)'
                statement = self.cur.mogrify(statement, (alertContextID, targetID, "alertcontexthastarget"))
                self.cur.execute(statement)
            else:
                alertContextID = alertContextID[0]
                        
            statement = 'insert into alertToContext (fromnode,tonode,name) VALUES(%s,%s,%s)'
            statement = self.cur.mogrify(statement, (alertID, alertContextID, "alerttocontext"))
            self.cur.execute(statement)

            
        self.conn.commit()

        logger.info( '"{0}" committed incomming Alerts with AlertID "{1}" and ContextID "{2}"'.format(self.__module__, alertID, alertContextID) )

        return {'status': 'success'}

class PlugIn (Process):

    def __init__(self, dbs, q):
        Process.__init__(self)
        self.app = Flask(__name__)
        self.log = logging.getLogger('werkzeug')
        self.log.disabled = True
        self.app.logger.disabled = True
        self.api = Api(self.app)
        self.dbs = dbs
        if self.dbs.backend == 'psql':
            self.DBconnect = psycopg2.connect(database=dbs.database, user=dbs.user, password=dbs.pwd, port=dbs.port, host=dbs.server)
            self.insert = self.conn.cursor()
        elif self.dbs.backend == 'orient':
            self.insert = pyorient.OrientDB(dbs.server, dbs.port)
            self.DBconnect = self.client.connect(dbs.user, dbs.pwd)
            self.insert.db_open(dbs.database, dbs.user, dbs.pwd)
        else:
            print ("Wrong backend: ", dbs.backend)
            logger.error("Wrong backend: %s", dbs.backend)
            sys.exit(0)


    def stop(self):
        logger.info( 'Stopped "{0}"'.format(self.__module__) )
        self.cur.close()
        self.conn.close()

    def run(self):

        logger.info( 'Start "{0}"'.format(self.__module__) )

        self.api.add_resource(IDMEF, '/alert', resource_class_kwargs={'cur': self.cur, 'conn': self.conn})

        self.app.run(debug=True, port=7873, use_reloader=False)
            

